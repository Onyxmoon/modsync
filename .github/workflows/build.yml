name: Build Plugin

on:
  push:
    tags:
      - '*.*.*'       # Matches 0.1.0, 1.2.3, etc.
      - '*.*.*-*'     # Matches 0.1.0-alpha, 0.1.0-beta.1, etc.
  workflow_dispatch:  # Allows manual trigger for testing
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Java 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
    
    - name: Cache Gradle Dependencies
      uses: actions/cache@v5
      with:
        path: ~/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant Execute Permission for Gradlew
      run: chmod +x gradlew

    - name: Setup Hytale (with download)
      uses: ./.github/actions/setup-hytale
      with:
        credentials: ${{ secrets.HYTALE_DOWNLOADER_CREDENTIALS }}

    - name: Build with Gradle
      run: ./gradlew build

    - name: Upload Artifact (all)
      uses: actions/upload-artifact@v4
      with:
        name: modsync-jars
        path: |
          build/libs/*.jar
          bootstrap/build/libs/*.jar
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: modsync-jars
          path: dist

      - name: List release files
        run: ls -la dist

      - name: Extract release notes from changelog
        id: release_notes
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          awk -v ver="$version" '
            $0 ~ "^## \\[" ver "\\]" {in_section=1; next}
            in_section && $0 ~ "^## \\[" {exit}
            in_section {print}
          ' CHANGELOG.md > release-notes.txt

          if [ ! -s release-notes.txt ]; then
            echo "Release notes not found for version $version in CHANGELOG.md." > release-notes.txt
          fi

          prev_version="$(awk -v ver="$version" '
            $0 ~ "^## \\[" ver "\\]" {in_section=1; next}
            in_section && $0 ~ "^## \\[" {
              if (match($0, /^## \\[([^\\]]+)\\]/, m)) {
                print m[1];
              }
              exit
            }
          ' CHANGELOG.md)"

          body="## ${version}"$'\n\n'"$(cat release-notes.txt)"
          if [ -n "$prev_version" ]; then
            compare_url="https://github.com/${GITHUB_REPOSITORY}/compare/${prev_version}...${version}"
            body="${body}"$'\n\n'"Compare: ${compare_url}"
          fi

          {
            echo "body<<EOF"
            echo "$body"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "ModSync ${{ github.ref_name }}"
          body: ${{ steps.release_notes.outputs.body }}
          files: |
            dist/**/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
